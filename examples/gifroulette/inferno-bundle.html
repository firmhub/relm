<!doctype html>
<html>
<head></head>
<body>
<div id="app"></div>
<!--<script src="../dist/relm-inferno.js"></script>-->
<!--<script src="relm-inferno.js"></script>-->
<script src="http://localhost:8080/relm-inferno.js"></script>
<script>

  function App (h, { state }) {
    return h('Flexbox[row]', [
      h('Flexbox', { style: { flex: 1 } }, h('Sidebar')),
      h('Flexbox', { style: { flex: 2 } }, `Hello ${state.message}`),
    ]);
  }

  App.components = {
    Sidebar,
    Flexbox,
  };

  App.actions = {
    initializeState (state) {
      return state.set('message', 'from state');
    }
  };

  function Sidebar (h, { state, actions }) {
    return h('div.sidebar', [
      h('ul.topics', state.Topic.list.map((topic, key) =>
        h('Topic', { key, onAdd: actions.addTopic, onRemove: actions.removeTopic })
      )),
      h('div.info', 'ENTER to add a topic'),
      h('div.info', 'BACKSPACE to remove'),
    ]);
  }

  Sidebar.components = {
    Topic: list(Topic)
  };

  Sidebar.actions = {
    initializeState (state) {
      return state.concat('Topic.list', [
        { topic: 'people' },
        { topic: 'dogs' },
        { topic: 'horses' },
      ]);
    },
    addTopic (state) {
      // TODO: state update from here is replacing the root state; why?
      return state.concat('Topic.list', { topic: '' });
    }
  };

  Sidebar.styles = css => css`
    .topics {
      list-style: none;
      margin: 0 0 1rem 0;
      padding: 0;
    }

    .addTopic {
      display: block;
      width: 100%;
      padding: 0.2rem;
      background: transparent;
      border: none;
      transition: 0.2s;
    }

    .addTopic:hover {
      background: #f2f2f2;
      cursor: pointer;
    }

    .info {
      font-family: sans-serif;
      line-height: 1.3;
      font-size: 0.7em;
      color: #999;
      text-align: center;
    }
  `;

  function Topic (h, { state, actions }) {
    return h('input.topic[type=text]', {
      value: state.topic || '',
      onInput (e) {
        actions.changeTopic(e.target.value);
      }
    });
  }

  Topic.actions = {
    changeTopic (state, topic) {
      return state.set('topic', topic);
    }
  };

  Topic.styles = css => css`
    .topic {
      width: 100%;
      background: #f2f2f2;
      border-radius: 4px;
      border: 2px solid white;
      padding: 0.5rem;
    }

    .topic + .topic {
      margin-top: 0.5rem;
    }
  `;

  /* UI */

  function Flexbox (h, { props, children }) {
    const isRow = props.hasOwnProperty('row') && props.row !== false;
    const className = ['flex', isRow ? 'row' : 'column', props.className];
    return h('div', Object.assign({}, props, { className }), children);
  }

  Flexbox.styles = css => css`
    .flex {display: flex;}
    .row {}
    .column {padding: 1rem;}
  `;

  /* Higher order components */

  function mapValues (obj, fn) {
    return Object.keys(obj).reduce((out, k) => {
      out[k] = fn(obj[k], k, obj);
      return out;
    }, {});
  }

  function list (Component) {
    function List (h, { state, props, children }) {
      const key = props.key;
      return h.Component.render({
        state: state.list[key],
        props,
        children,
        components: h.Component.components,
        styles: h.Component.styles,
        actions: mapValues(h.Component.actions, (action) => (...args) => action(key, ...args)),
      });
    }

    List.displayName = `list<${Component.displayName || Component.name}>`;

    List.components = { Component };

    List.actions = {
      initializeState (state) {
        return state.set('list', []);
      },
      Component (state, next, key, ...args) {
        return state.set(['list', key], next(state.list[key], ...args));
      }
    };

    return List;
  }

  /* bootstrap */

  window.app = relm(App, {
    el: document.querySelector('#app'),
    customizeStore (reducer, initialState, middlewares) {
      function logBefore (state, action) {
        if (!action) console.trace(action);
        const actionType = [].concat(action && action.type).join('.');
        console.group(actionType);
        console.log('action', action);
        console.log('before', state);
        const update = reducer(state, action);
        console.log('after', update);
        console.groupEnd(actionType);
        return update;
      }
      return this.createStore(logBefore, initialState, this.applyMiddleware.apply(this, middlewares));
    }
  });

  // app.subscribe(function () {
  //   console.log('state', app.getState());
  // });

</script>
</body>
</html>